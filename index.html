<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>索尼徽章批量查询（陆续更新）</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 900px;
      margin: auto;
      padding: 30px;
      background: #fdfdfd;
    }
    textarea {
      width: 100%;
      height: 160px;
      margin-bottom: 10px;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 6px;
      color: #333;
    }
    button, .link-btn {
      padding: 10px 20px;
      background: #4caf50;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 15px;
      text-decoration: none;
      margin-right: 10px;
      display: inline-block;
    }
    button:disabled {
      background: #9e9e9e;
      cursor: not-allowed;
    }
    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
      font-size: 14px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background: #f0f0f0;
    }
    .success { background-color: #e8f5e9; }
    .fail { background-color: #f9f9f9; color: #999; }
    .footer {
      margin-top: 40px;
      text-align: right;
      font-size: 13px;
    }
    .summary {
      margin-top: 10px;
      font-weight: bold;
      font-size: 15px;
    }
  </style>
</head>
<body>

  <h2>索尼徽章批量查询（陆续更新）</h2>
  <p>每行一个钱包地址：</p>
  <textarea id="input" placeholder=""></textarea><br>
  <button id="queryBtn" onclick="check()">开始查询</button>
  <a href="https://badge.sonus.exchange/claim" target="_blank" class="link-btn">🎁 领取 Sonus 徽章</a>
  <a href="https://soneiumevent.unemeta.com/mint" target="_blank" class="link-btn">🎁 领取 Unemeta 徽章</a>
  <a href="https://owlto.finance/soneium-badge" target="_blank" class="link-btn">🎁 领取 Owlto 徽章</a>

  <!-- 统计信息顺序优化后 -->
  <div class="summary" id="sonusQualified"></div>
  <div class="summary" id="kyoHolders"></div>
  <div class="summary" id="sakeHolders"></div>
  <div class="summary" id="sonusHolders"></div>
  <div class="summary" id="ogHolders"></div>
  <div class="summary" id="unemetaHolders"></div>
  <div class="summary" id="owltoHolders"></div>
  <div class="summary" id="summary"></div>

  <table id="resultTable" style="display:none;">
    <thead>
      <tr>
        <th>序号</th>
        <th>地址</th>
        <th>KYO 徽章</th>
        <th>Sake 徽章</th>
        <th>Sonus资格</th>
        <th>Sonus徽章</th>
        <th>OG 徽章</th>
        <th>Unemeta 徽章</th>
        <th>Owlto 徽章</th>
      </tr>
    </thead>
    <tbody id="resultBody"></tbody>
  </table>

  <div class="footer">
    作者推特：<a href="https://x.com/0xXIAOc" target="_blank">@0xXIAOc</a>
  </div>

  <script>
    const kyoNFT = "0x11b2876c58cfb7501db60d0112af8a8efeb0a81d";
    const sakeNFT = "0x3a634e6f8c2bf2c5894722b908d99e3cf9c62ed3";
    const sonusNFT = "0x066aba7c3520e300113c0515ff41c084ee0c95ea";
    const ogNFT = "0x2A21B17E366836e5FFB19bd47edB03b4b551C89d";
    const unemetaNFT = "0xCA707D22E248740aDaA9C63580F7A35201B18d30"; // Unemeta 合约地址（改为从 ERC-721 接口查询）
    const owltoNFT = "0x1eC6AACC79f3c4817d7fea2268e1c54C6b2662Fb"; // Owlto 合约地址
    let sonusBadgeSet = new Set();

    // 获取徽章持有人数
    async function fetchBadgeHolders() {
      const badgeAPIs = [
        { url: "https://soneium.blockscout.com/api/v2/tokens/0x2A21B17E366836e5FFB19bd47edB03b4b551C89d", id: "ogHolders" }, // OG徽章
        { url: "https://soneium.blockscout.com/api/v2/tokens/0x3a634e6f8c2bf2c5894722b908d99e3cf9c62ed3", id: "sakeHolders" }, // Sake徽章
        { url: "https://soneium.blockscout.com/api/v2/tokens/0x11b2876c58cfb7501db60d0112af8a8efeb0a81d", id: "kyoHolders" }, // KYO徽章
        { url: "https://soneium.blockscout.com/api/v2/tokens/0x066aba7c3520e300113c0515ff41c084ee0c95ea", id: "sonusHolders" }, // Sonus徽章
        { url: "https://soneium.blockscout.com/api/v2/tokens/0xCA707D22E248740aDaA9C63580F7A35201B18d30", id: "unemetaHolders" }, // Unemeta徽章
        { url: "https://soneium.blockscout.com/api/v2/tokens/0x1eC6AACC79f3c4817d7fea2268e1c54C6b2662Fb", id: "owltoHolders" } // Owlto徽章
      ];

      for (let { url, id } of badgeAPIs) {
        try {
          const response = await fetch(url);
          const data = await response.json();
          document.getElementById(id).innerText = `📊 当前持有 ${id.replace('Holders', '')} 徽章的钱包数：${data.holders}`;
        } catch (err) {
          console.error(`无法加载 ${id} 数据：`, err);
        }
      }
    }

    // 加载 Sonus 徽章资格数据
    async function loadSonusBadgeData() {
      try {
        const res = await fetch("https://badge.sonus.exchange/static/js/main.dace8027.js");
        const text = await res.text();
        const matches = text.match(/"0x[a-fA-F0-9]{40}":1/g);
        if (matches) {
          matches.forEach(match => {
            const addr = match.slice(1, 43).toLowerCase();
            sonusBadgeSet.add(addr);
          });
        }
        document.getElementById("sonusQualified").innerText = `📦 Sonus 徽章 符合资格人数：${sonusBadgeSet.size}`;
      } catch (err) {
        document.getElementById("sonusQualified").innerText = `❌ 无法加载 Sonus资格数据：${err.message}`;
      }
    }

    async function check() {
      const raw = document.getElementById("input").value.trim();
      const addresses = raw.split("\n").map(x => x.trim().toLowerCase()).filter(Boolean);
      if (!addresses.length) return alert("请输入地址");

      const btn = document.getElementById("queryBtn");
      const tbody = document.getElementById("resultBody");
      const table = document.getElementById("resultTable");
      const summary = document.getElementById("summary");

      btn.innerText = "查询中...";
      btn.disabled = true;
      tbody.innerHTML = "";
      table.style.display = "table";
      summary.innerText = "";

      let kyoCount = 0, sakeCount = 0, sonusListCount = 0, sonusNFTCount = 0, ogCount = 0, unemetaCount = 0, owltoCount = 0;

      for (let i = 0; i < addresses.length; i++) {
        const addr = addresses[i];
        const row = document.createElement("tr");

        let hasKyo = false, hasSake = false, hasSonusNFT = false, hasOG = false, hasUnemeta = false, hasOwlto = false;
        const hasSonusList = sonusBadgeSet.has(addr);

        try {
          // ERC-721查询
          const res721 = await fetch(`https://soneium.blockscout.com/api/v2/addresses/${addr}/tokens?type=ERC-721`);
          const json721 = await res721.json();
          const items721 = json721.items || [];

          const kyoItem = items721.find(item => item.token?.address?.toLowerCase() === kyoNFT.toLowerCase());
          const sakeItem = items721.find(item => item.token?.address?.toLowerCase() === sakeNFT.toLowerCase());
          const sonusItem = items721.find(item => item.token?.address?.toLowerCase() === sonusNFT.toLowerCase());
          // 现在将 Unemeta 徽章也从 ERC-721 中查找
          const unemetaItem = items721.find(item => item.token?.address?.toLowerCase() === unemetaNFT.toLowerCase());

          hasKyo = !!kyoItem;
          hasSake = !!sakeItem;
          hasSonusNFT = !!sonusItem;
          hasUnemeta = !!unemetaItem;

          if (hasKyo) kyoCount++;
          if (hasSake) sakeCount++;
          if (hasSonusList) sonusListCount++;
          if (hasSonusNFT) sonusNFTCount++;
          if (hasUnemeta) unemetaCount++;

          // ERC-1155查询
          const res1155 = await fetch(`https://soneium.blockscout.com/api/v2/addresses/${addr}/tokens?type=ERC-1155`);
          const json1155 = await res1155.json();
          const items1155 = json1155.items || [];

          const ogItem = items1155.find(item => item.token?.address?.toLowerCase() === ogNFT.toLowerCase());
          hasOG = !!ogItem;
          if (hasOG) ogCount++;

          const owltoItem = items1155.find(item => item.token?.address?.toLowerCase() === owltoNFT.toLowerCase());
          hasOwlto = !!owltoItem;
          if (hasOwlto) owltoCount++;

        } catch (e) {
          row.className = "fail";
          row.innerHTML = `<td>${i + 1}</td><td>${addr}</td><td colspan="8">❌ 查询失败</td>`;
          tbody.appendChild(row);
          continue;
        }

        row.className = hasKyo || hasSake || hasSonusList || hasSonusNFT || hasOG || hasUnemeta || hasOwlto ? "success" : "fail";
        row.innerHTML = `
          <td>${i + 1}</td>
          <td>${addr}</td>
          <td>${hasKyo ? "✅ 是" : "❌ 否"}</td>
          <td>${hasSake ? "✅ 是" : "❌ 否"}</td>
          <td>${hasSonusList ? "✅ 是" : "❌ 否"}</td>
          <td>${hasSonusNFT ? "✅ 是" : "❌ 否"}</td>
          <td>${hasOG ? "✅ 是" : "❌ 否"}</td>
          <td>${hasUnemeta ? "✅ 是" : "❌ 否"}</td>
          <td>${hasOwlto ? "✅ 是" : "❌ 否"}</td>
        `;
        tbody.appendChild(row);
      }

      summary.innerText = `✅ 总地址数：${addresses.length}，KYO：${kyoCount}，Sake：${sakeCount}，Sonus资格：${sonusListCount}，Sonus徽章：${sonusNFTCount}，OG徽章：${ogCount}，Unemeta徽章：${unemetaCount}，Owlto徽章：${owltoCount}`;
      btn.innerText = "开始查询";
      btn.disabled = false;
    }

    loadSonusBadgeData();
    fetchBadgeHolders();
  </script>

</body>
</html>
